{% extends "base.html" %}
{% block content %}
<h1 class="h4 mb-4">üìä T·ªïng quan</h1>

<style>
  /* Style ri√™ng cho dashboard */
  .stat-card {
    text-align: center;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 10px;
    padding: 20px 10px;
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
  }
  .stat-title {
    font-size: 0.95rem;
    color: #6c757d;
    margin-bottom: 8px;
  }
  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
  }
  .bg-light-blue {
    background: #eaf4ff;
  }
  .bg-light-green {
    background: #e9f9f0;
  }
</style>

<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card stat-card h-100 bg-gradient-primary text-white shadow-sm">
      <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
        <div class="stat-icon mb-2"><i class="bi bi-box-seam"></i></div>
        <div class="text-uppercase small fw-semibold">S·ªë s·∫£n ph·∫©m</div>
        <div class="display-6 fw-bold">{{ total_products }}</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card stat-card h-100 bg-gradient-success text-white shadow-sm">
      <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
        <div class="stat-icon mb-2"><i class="bi bi-bar-chart-fill"></i></div>
        <div class="text-uppercase small fw-semibold">T·ªïng t·ªìn</div>
        <div class="display-6 fw-bold">{{ total_qty }}</div>
      </div>
    </div>
  </div>

  <!-- Bieu do top ton kho-->
  <div class="col-md-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="fw-semibold">üì¶ Top s·∫£n ph·∫©m t·ªìn kho</span>
        </div>
        <canvas id="topStockChart" height="100"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Nh·∫≠p h√†ng -->
  <div class="col-lg-6">
    <div class="card shadow-sm border-0 form-card in-card">
      <div class="card-header bg-success bg-opacity-10 fw-semibold d-flex align-items-center">
        <i class="bi bi-box-arrow-in-down me-2 text-success"></i> Nh·∫≠p h√†ng
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('stock_in') }}" class="row g-3">
          <div class="col-12">
            <label class="form-label">T√™n s·∫£n ph·∫©m</label>
            <input type="text" class="form-control product-autocomplete" name="name" placeholder="VD: Bu l√¥ng M8" required>
          </div>
          <div class="col-6">
            <label class="form-label">S·ªë l∆∞·ª£ng</label>
            <input type="number" class="form-control" name="quantity" min="1" required>
          </div>
          <div class="col-6">
            <label class="form-label">Ng√†y nh·∫≠p</label>
            <input type="date" class="form-control" name="tx_date">
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-success">üì• Nh·∫≠p</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Xu·∫•t h√†ng -->
  <div class="col-lg-6">
    <div class="card shadow-sm border-0 form-card out-card">
      <div class="card-header bg-danger bg-opacity-10 fw-semibold d-flex align-items-center">
        <i class="bi bi-box-arrow-up me-2 text-danger"></i> Xu·∫•t h√†ng
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('stock_out') }}" class="row g-3">
          <div class="col-12">
            <label class="form-label">T√™n s·∫£n ph·∫©m</label>
            <input type="text" class="form-control product-autocomplete" name="name" placeholder="G√µ ƒë·ªÉ g·ª£i √Ω..." required>
          </div>
          <div class="col-6">
            <label class="form-label">S·ªë l∆∞·ª£ng</label>
            <input type="number" class="form-control" name="quantity" min="1" required>
          </div>
          <div class="col-6">
            <label class="form-label">Ng√†y xu·∫•t</label>
            <input type="date" class="form-control" name="tx_date">
          </div>
          <div class="col-12 text-end">
            <button class="btn btn-danger">üì§ Xu·∫•t</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm border-0 mt-4 tx-card">
  <div class="card-header bg-light fw-semibold">
    <i class="bi bi-clock-history me-2 text-secondary"></i> Giao d·ªãch g·∫ßn ƒë√¢y
  </div>
  <div class="card-body table-responsive">
    <table class="table table-sm align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Ng√†y</th><th>S·∫£n ph·∫©m</th><th>Lo·∫°i</th><th>S·ªë l∆∞·ª£ng</th><th>Th·ªùi gian t·∫°o</th>
        </tr>
      </thead>
      <tbody>
        {% for tx in latest_txs %}
        <tr>
          <td>{{ tx.tx_date.strftime('%Y-%m-%d') }}</td>
          <td>
            <a href="{{ url_for('product_detail', product_id=tx.product.id) }}" class="text-decoration-none fw-semibold">
              {{ tx.product.name }}
            </a>
          </td>
          <td>
            <span class="badge rounded-pill 
              {% if tx.type=='IN' %} bg-success bg-opacity-25 text-success 
              {% else %} bg-danger bg-opacity-25 text-danger {% endif %}">
              {{ 'Nh·∫≠p' if tx.type=='IN' else 'Xu·∫•t' }}
            </span>
          </td>
          <td class="fw-semibold">{{ tx.quantity }}</td>
          <td class="text-muted">{{ tx.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" class="text-muted text-center">Ch∆∞a c√≥ giao d·ªãch.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Ve bieu do top san pham-->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  new Chart(document.getElementById('topStockChart'), {
    type: 'bar',
    data: {
      labels: {{ top_labels | tojson }},
      datasets: [{
          label: 'S·ªë l∆∞·ª£ng t·ªìn',
          data: {{ top_values | tojson }},
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      plugins: { legend: { display: false }, title: { display: false } },
      scales: { x: { beginAtZero: true } }
    }
  })
</script>
{% endblock %}
